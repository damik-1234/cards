<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>3D Lanovka s Texturami</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">
        <b>W,A,S,D</b> - Pohyb | <b>Myš</b> - Rozhlížení (klikni do okna)<br>
        Nastup do červené kabiny a vyjeď na horu!
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- POMOCNÁ FUNKCE PRO GENEROVÁNÍ TEXTUR ---
        function createNoiseTexture(color1, color2, size = 256) {
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = size;
            const ctx = canvas.getContext('2d');
            for (let i = 0; i < size; i += 4) {
                for (let j = 0; j < size; j += 4) {
                    ctx.fillStyle = Math.random() > 0.5 ? color1 : color2;
                    ctx.fillRect(i, j, 4, 4);
                }
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(10, 10);
            return tex;
        }

        // --- SCÉNA A RENDERER ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        scene.fog = new THREE.Fog(0x87ceeb, 10, 150);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 500);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- SVĚTLO ---
        const light = new THREE.DirectionalLight(0xffffff, 1.2);
        light.position.set(50, 100, 50);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));

        // --- OBJEKTY S TEXTURAMI ---
        
        // Tráva (Země)
        const grassTex = createNoiseTexture('#2d5a27', '#3a7d32');
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(500, 500),
            new THREE.MeshLambertMaterial({ map: grassTex })
        );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // Hora (Skála)
        const rockTex = createNoiseTexture('#555555', '#777777');
        rockTex.repeat.set(2, 5);
        const mountain = new THREE.Mesh(
            new THREE.ConeGeometry(30, 80, 8),
            new THREE.MeshLambertMaterial({ map: rockTex })
        );
        mountain.position.set(0, 40, -80);
        scene.add(mountain);

        // Lanovka
        const carGroup = new THREE.Group();
        const carMat = new THREE.MeshPhongMaterial({ color: 0xaa0000, shininess: 80 });
        const carBody = new THREE.Mesh(new THREE.BoxGeometry(4, 3, 4), carMat);
        carGroup.add(carBody);
        
        // Okna lanovky
        const winMat = new THREE.MeshPhongMaterial({ color: 0x88ccff, transparent: true, opacity: 0.6 });
        const windowFront = new THREE.Mesh(new THREE.BoxGeometry(3.5, 1.5, 0.1), winMat);
        windowFront.position.set(0, 0.5, 2.01);
        carGroup.add(windowFront);

        carGroup.position.set(0, 1.6, -15);
        scene.add(carGroup);

        // Lana
        const lineMat = new THREE.LineBasicMaterial({ color: 0x333333 });
        const linePoints = [new THREE.Vector3(0, 2, -15), new THREE.Vector3(0, 75, -75)];
        const lineGeo = new THREE.BufferGeometry().setFromPoints(linePoints);
        const cable = new THREE.Line(lineGeo, lineMat);
        scene.add(cable);

        // --- OVLÁDÁNÍ ---
        let keys = {};
        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);
        renderer.domElement.addEventListener('click', () => renderer.domElement.requestPointerLock());

        let yaw = 0, pitch = 0;
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement) {
                yaw -= e.movementX * 0.002;
                pitch = Math.max(-1.5, Math.min(1.5, pitch - e.movementY * 0.002));
                camera.rotation.set(pitch, yaw, 0, 'YXZ');
            }
        });

        // --- ANIMACE ---
        let carTime = 0;
        const startPos = new THREE.Vector3(0, 1.6, -15);
        const endPos = new THREE.Vector3(0, 72, -73);

        function update() {
            // Animace lanovky
            carTime += 0.003;
            const progress = (Math.sin(carTime) + 1) / 2;
            const oldPos = carGroup.position.clone();
            carGroup.position.lerpVectors(startPos, endPos, progress);

            // Chůze
            const speed = 0.15;
            const dir = new THREE.Vector3();
            if (keys['KeyW']) dir.z -= 1;
            if (keys['KeyS']) dir.z += 1;
            if (keys['KeyA']) dir.x -= 1;
            if (keys['KeyD']) dir.x += 1;
            
            dir.applyQuaternion(new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), yaw));
            camera.position.addScaledVector(dir.normalize(), speed);

            // Logika "nastoupení"
            const dist = camera.position.distanceTo(carGroup.position);
            if (dist < 3) {
                const delta = carGroup.position.clone().sub(oldPos);
                camera.position.add(delta); // Hráč se pohybuje s kabinou
            } else {
                camera.position.y = 1.7; // Udržuj hráče na zemi, pokud není v kabině
            }

            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        camera.position.set(0, 1.7, 0);
        update();
    </script>
</body>
</html>
